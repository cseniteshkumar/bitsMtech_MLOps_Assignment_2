name: Scheduled Health Checks

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:

jobs:
  dependency-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    
    - name: Check for outdated dependencies
      run: |
        pip install pip-audit safety
        echo "=== Checking for known vulnerabilities ==="
        pip-audit --desc || true
        echo ""
        echo "=== Checking for outdated packages ==="
        pip list --outdated || true
    
    - name: Check dependency conflicts
      run: |
        pip install pipdeptree
        pipdeptree --warn fail || true

  code-quality-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
    
    - name: Install analysis tools
      run: |
        pip install pylint radon
    
    - name: Run Pylint
      run: |
        pylint app/ --disable=all --enable=E,F --fail-under=9 || true
    
    - name: Check code complexity
      run: |
        radon cc app/ -a -s
        radon mi app/ -s

  docker-image-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Build Docker image
      run: docker build -t mlops-check:latest .
    
    - name: Scan with Trivy
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'mlops-check:latest'
        format: 'table'
        exit-code: '0'

  test-coverage-trend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Install test tools
      run: |
        pip install -r requirements_fastapi.txt
        pip install pytest pytest-cov
    
    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=app --cov-report=term-missing --cov-report=json
        
        python -c "
        import json
        with open('coverage.json') as f:
          data = json.load(f)
          coverage = data['totals']['percent_covered']
          print(f'Coverage: {coverage:.1f}%')
          
          if coverage < 70:
            print('⚠️  Coverage below 70%')
          elif coverage < 80:
            print('⚠️  Coverage below 80%')
          else:
            print('✓ Coverage above 80%')
        "
    
    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      uses: py-cov-action/python-coverage-comment-action@v3
      with:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
