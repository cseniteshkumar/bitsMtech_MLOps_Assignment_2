name: API Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    services:
      app:
        image: python:3.9
        options: >-
          --health-cmd="python -c 'import sys; sys.exit(0)'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements_fastapi.txt
        pip install pytest pytest-asyncio httpx
    
    - name: Start FastAPI server
      run: |
        python -m app.main &
        SERVER_PID=$!
        sleep 5
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
    
    - name: Run integration tests
      run: |
        pytest tests/testDeployment.py -v --tb=short
    
    - name: Run API endpoint tests
      run: |
        python -c "
        import requests
        import time
        
        BASE_URL = 'http://localhost:8000'
        
        # Health check
        try:
          response = requests.get(f'{BASE_URL}/')
          print(f'Root endpoint: {response.status_code}')
          assert response.status_code == 200
        except Exception as e:
          print(f'Failed: {e}')
          exit(1)
        
        # Predict endpoint
        try:
          response = requests.post(f'{BASE_URL}/api/predict', json={'features': [1.0, 2.0]})
          print(f'Predict endpoint: {response.status_code}')
        except Exception as e:
          print(f'Predict endpoint not available or error: {e}')
        "
    
    - name: Load testing with Locust
      continue-on-error: true
      run: |
        pip install locust
        cat > locustfile.py << 'EOF'
        from locust import HttpUser, task, between
        
        class APIUser(HttpUser):
          wait_time = between(1, 3)
          
          @task
          def root(self):
            self.client.get("/")
          
          @task
          def predict(self):
            self.client.post("/api/predict", json={"features": [1.0, 2.0]})
        EOF
        
        locust -f locustfile.py --headless -u 10 -r 2 -t 30s --host=http://localhost:8000 --csv=results || true
    
    - name: Upload test reports
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: test-reports
        path: results/

  performance-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        cache: 'pip'
    
    - name: Install performance testing tools
      run: |
        pip install -r requirements_fastapi.txt
        pip install pytest-benchmark memory-profiler
    
    - name: Run performance benchmarks
      run: |
        python -c "
        import time
        import sys
        sys.path.insert(0, '.')
        
        from app.main import app
        from fastapi.testclient import TestClient
        
        client = TestClient(app)
        
        # Benchmark root endpoint
        start = time.time()
        for _ in range(100):
          client.get('/')
        elapsed = time.time() - start
        
        print(f'100 requests to root: {elapsed:.2f}s')
        print(f'Average: {elapsed/100*1000:.2f}ms')
        
        if elapsed/100 > 0.1:  # 100ms warning
          print('⚠️  Response time slower than expected')
        "
