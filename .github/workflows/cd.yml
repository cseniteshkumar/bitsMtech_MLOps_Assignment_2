name: CD Pipeline

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_run:
    workflows: [ "Docker Build & Push" ]
    types: [ completed ]
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  CONTAINER_NAME: mlops-classifier

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event.workflow_run.conclusion == 'success')
    
    environment:
      name: production
      url: http://${{ secrets.DEPLOY_HOST }}/
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Extract Docker image tag
      id: image
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
        else
          TAG=${{ github.sha }}
        fi
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}" >> $GITHUB_OUTPUT
    
    - name: Deploy to production
      if: always()
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ env.DEPLOY_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
        # Deploy script
        ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
          cd /app
          docker pull ${{ steps.image.outputs.image }}
          docker-compose down || true
          docker-compose up -d
          sleep 10
          curl -f http://localhost:8000/ || exit 1
          echo "Deployment successful"
        EOF

  health-check:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Health check endpoint
      run: |
        for i in {1..5}; do
          echo "Health check attempt $i/5"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.DEPLOY_HOST }}/ || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "Health check passed"
            exit 0
          fi
          sleep 10
        done
        echo "Health check failed"
        exit 1
      continue-on-error: true

  rollback:
    runs-on: ubuntu-latest
    needs: [ deploy, health-check ]
    if: failure() && github.event_name == 'push'
    
    steps:
    - name: Rollback deployment
      env:
        DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
      run: |
        mkdir -p ~/.ssh
        echo "${{ env.DEPLOY_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H ${{ env.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
        ssh -i ~/.ssh/deploy_key ${{ env.DEPLOY_USER }}@${{ env.DEPLOY_HOST }} << 'EOF'
          cd /app
          # Revert to previous version or stop service gracefully
          docker-compose down
          echo "Rolled back deployment"
        EOF
    
    - name: Notify rollback
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '⚠️ Deployment rolled back due to health check failure'
          })
